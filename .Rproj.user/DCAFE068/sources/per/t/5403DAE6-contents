---
title: "16S Analysis - Vallance_Franzi_Profast"
author: "Alana Schick, Gut4Health"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: yeti
    highlight: kate
    toc: yes
    toc_float:
      collapsed: no
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: '3'
    highlight: tango
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
## Load libraries
library(phyloseq)
library(tidyverse)
library(ape)
library(vegan)
library(viridis)
library(grid)
library(gridExtra)
library(DESeq2)
library(fields)
library(nlme)
library(RColorBrewer)
library(pheatmap)
library(knitr)
library(kableExtra)
library(ggpubr)
library(plotrix)
library(corncob)
library(plyr)
library(gplots)
library(corrr)
```

## Summary

The aim of this work is profile the microbial community of samples from two clinical trials investigating the effect of prolonged fasting. 

<!-- ## Overview of Activities Conducted -->

<!-- Microbial communities were profiled using sequence data from the V3-V4 region of the 16S rRNA amplicon. Following quality control and filtering of sequence data, taxonomic compositions of each sample were determined using a custom pipeline implementing the dada2 R package.  -->

<!-- This report contains the full analysis of these samples and is presented in sections corresponding to preliminary analysis, taxonomic overview, alpha diversity, beta diversity, and differential abundance. -->

<!-- ## Summary of Findings -->

<!-- Overall, profiling of gut microbiota communities revealed large amounts of variation across patients. This variation can be visualized in the section summarizing taxonomic composition.  -->

<!-- In patients with multiple sclerosis (MS), there was no effect of fasting on alpha diversity. However, alpha diversity was found to decrease over a longer time frame when comparing baseline to follow-up. Interestingly, in patients with type 1 diabetes (T1D), fasting significantly increased alpha diversity.   -->

<!-- In terms of overall community composition (beta diversity), there was no significant effect of fasting observed in either MS patients or T1D patients. The lack of significance here is likely due to large differences between patients and low sample numbers.  -->

<!-- When comparing individual taxa, fasting in MS patients was found to be associated with an increase in the genera Bacteroides, Butyricimnonas, and Faecalibacterium, and a decrease in Christensenellaceae and Akkermansia, though this effect is not present in all samples. In control (healthy) patients, fasting appeared to increase variants in the genera Bacteroides, Lachnospiraceae UCG-001, Faecalibacterium, Ruminococcus, and Oscillibacter, along with decreases in Prevotella, Barnesiella, Christensenellaceae, Butyrivibrio, Anaerostipes, and Sutterella. In contrast to both healthy and MS patients, fasting appeared to decrease Faecalibacterium and Bacteroides in T1D patients and increase Lachnospiraceae amd Bifidobacterium.  -->



```{r load}
path_to_project <- "/Users/alana.schick/Desktop/dropbox_temp/bcch/projects/franzi_profast/"

## Read in files
seqtab <- readRDS(file.path(path_to_project, "dada2/results/seqtab_final.rds"))
taxa <- readRDS(file.path(path_to_project, "dada2/results/taxa_final.rds"))
info <- read.csv(file.path(path_to_project, "franzi_profast_metadata.csv"), header = TRUE)

## Match sample names
rownames(info) <- info$SampleID

## Make a phyloseq object
ps <- phyloseq(otu_table(seqtab, taxa_are_rows=FALSE), sample_data(info), tax_table(taxa))

## Remove sequence names, rename to something manageable
## To add: write a file comtaining the ASV_# names and sequences 
asv_names <- vector(dim(otu_table(ps))[2], mode = "character")
for (i in 1:dim(otu_table(ps))[2]){
	asv_names[i] <- paste("ASV", i, sep = "_")
}
taxa_names(ps) <- asv_names
colnames(otu_table(ps)) <- asv_names
rownames(tax_table(ps)) <- asv_names

## Convert day to a factor
sample_data(ps)$Day <- as.factor(sample_data(ps)$day_of_treatment)

## Remove control samples and samples from other studies
ps <- prune_samples(sample_data(ps)$study_name %in% c("NAMS", "T1DMS"), ps)


```

## Preliminary Analysis

### Reads per sample

Histogram of reads per sample after quality-filtering. The vertical line represents the cutoff (1000 reads) for samples included in the analysis.

```{r, fig.height = 4, fig.width = 7}
## Check read counts per sample
sums <- rowSums(otu_table(ps))
counts <- data.frame(as(sample_data(ps), "data.frame"), totalreads = sums)

qq <- ggplot(counts, aes(totalreads)) + 
  geom_histogram(binwidth = 0.02, colour= NA, fill = "blue") + 
  ggtitle("Read counts per sample") + 
  scale_x_log10() + 
  geom_vline(xintercept = 1000, lty = 2) +
  theme_bw() +
  xlab("Number of reads") +
  ylab("Number of samples")
qq
```

### By study

```{r, fig.height = 4, fig.width = 7}

## By sequencing run
pp <- ggplot(counts, aes(x = totalreads)) +
  geom_histogram(fill = "blue", colour = NA) +
  theme_bw() +
  scale_x_log10() +
  facet_wrap(~study_name) +
  xlab("Number of reads") +
  ylab("Number of samples")
pp
```

<!-- ### By treatment -->

<!-- NAMS -->

<!-- ```{r, fig.height = 4, fig.width = 7} -->
<!-- ## Check read counts by treatment group -->
<!-- counts1 <- counts[counts$study_name == "NAMS",] -->
<!-- tt <- ggplot(counts1, aes(x = study_group, y = totalreads)) +  -->
<!--   geom_point() + facet_wrap(~study_timepoint) +  -->
<!--   theme_bw() + -->
<!--   ylab("Number of reads") -->
<!-- tt -->
<!-- ``` -->

<!-- T1DMS -->

<!-- ```{r, fig.height = 4, fig.width = 7} -->
<!-- ## Check read counts by treatment group -->
<!-- counts2 <- counts[counts$study_name == "T1DMS",] -->
<!-- tt <- ggplot(counts2, aes(x = study_group, y = totalreads)) +  -->
<!--   geom_point() + facet_wrap(~study_timepoint) +  -->
<!--   theme_bw() + -->
<!--   ylab("Number of reads") -->
<!-- tt -->
<!-- ``` -->

### Samples removed

Five samples had <1K reads and were therefore removed from the analysis.

```{r}

## Looks like 3 samples have less than 1000 reads
failed <- counts %>% filter(totalreads < 1000)
failed <- failed %>% select(study_group, Day, totalreads)

failed
#kable(failed) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

## Remove samples with fewer than 1000 reads
samples_failed <- sample_sums(ps) >= 1000
ps <- prune_samples(samples_failed, ps)

################################
## Prevalence filtering
## Compute prevalence - number of samples in which a taxon appears at least once
prevdf <- apply(X = otu_table(ps), MARGIN = ifelse(taxa_are_rows(ps), yes = 1, no = 2), FUN = function(x){sum(x > 0)})
prevdf <- data.frame(prevalence = prevdf, total_abundance = taxa_sums(ps), tax_table(ps))

## Remove low-prevalence taxa - prevalence defined as the number of samples containing that taxa
## Define prevalence threshold as 5% of total samples
prevalence_threshold <- 0.05 * nsamples(ps)
count_threshold <- 2*prevalence_threshold

## Define taxa to filter
keeptaxa <- rownames(prevdf)[(prevdf$prevalence >= prevalence_threshold) & (prevdf$total_abundance > count_threshold)]

## Take relative abundance
rel <- transform_sample_counts(ps, function(x) x / sum(x))

## Execute filter
psf <- prune_taxa(keeptaxa, ps)

## Take relative abundance
relf <- transform_sample_counts(psf, function(x) x / sum(x))
#########################################

###########################################
## Ordination - Check for outliers
pslog <- transform_sample_counts(psf, function(x) log(1 + x))

ord <- ordinate(pslog, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(pslog, ord, color = "study_group", shape = "Day") +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw() +
  scale_color_manual(values = rainbow(5, v = 0.8))
##bb


## Variance stabilizing transformation
dd <- phyloseq_to_deseq2(ps, ~1)
gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans = apply(counts(dd), 1, gm_mean)
dd = estimateSizeFactors(dd, geoMeans = geoMeans)
dd = estimateDispersions(dd, fitType = "local")
#plotDispEsts(dddisp)
psvst = ps
otu_table(psvst) <- otu_table(getVarianceStabilizedData(dd), taxa_are_rows = TRUE)

```

### Sample overview

NAMS

```{r}
nams <- sample_data(ps)[sample_data(ps)$study_name == "NAMS",]
tab <- nams %>% group_by(study_group, day_of_treatment, study_timepoint, nutritional_group) %>% dplyr::summarise(n = n())
#kable(tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
as.data.frame(tab)
```

T1DMS

```{r}
tdm <- sample_data(ps)[sample_data(ps)$study_name == "T1DMS",]
tab <- tdm %>% group_by(study_group, day_of_treatment, study_timepoint, nutritional_group) %>% dplyr::summarise(n = n())
#kable(tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
as.data.frame(tab)
```

### Ordination

Based on an ordination of all sequence variants found across samples, no outlier samples were removed from the analysis. 

```{r}
bb
```

## Taxonomic Overview {.tabset .tabset-fade}

Summary of common taxa present in each sample. For Family and Genus level, only top 10 most abundant taxa are included. Therefore, some samples will have relative abundances that do not sum to 1 because they have less abundant taxa present but not shown in these plots. 

### NAMS - Phlyum

```{r, fig.height =10, fig.width = 8}

## Define a function to generate the barplot with an option to change the border colour
plot_bar2 <-  function (physeq, x = "Sample", y = "Abundance", fill = NULL, title = NULL, facet_grid = NULL, border_color = NA) 
{
  mdf = psmelt(physeq)
  p = ggplot(mdf, aes_string(x = x, y = y, fill = fill))
  p = p + geom_bar(stat = "identity", position = "stack",  color = border_color)
  p = p + theme(axis.text.x = element_text(angle = -90, hjust = 0))
  if (!is.null(facet_grid)) {
    p <- p + facet_grid(facet_grid)
  }
  if (!is.null(title)) {
    p <- p + ggtitle(title)
  }
  return(p)
}

## Setting colours
cc10 <- c("#800000", "#e6194b", "#f58231", "#ffe119", "#bfef45", "#3cb44b", "#42d4f4", "#4363d8", "#911eb4", "#f032e6")

## Subset
nams <- prune_samples(sample_data(psf)$study_name == "NAMS", psf)
tdm <- prune_samples(sample_data(psf)$study_name == "T1DMS", psf)

## Agglomerate to Phylum level
phy <- tax_glom(nams, "Phylum")

## Normalize to relative abundance
phyrel <- transform_sample_counts(phy, function(x) x/sum(x))

phycomp <- plot_bar2(phyrel, x = "Day", fill = "Phylum", border_color = NA) + 
  scale_fill_manual(values = cc10) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
  theme_bw() + xlab("Day") + ylab("Relative abundance") +
  theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
  facet_wrap(~nutritional_group+SubjectID, scales = "free", nrow = 4)
phycomp



# phycomp <- plot_bar2(phyrel, x = "Day", fill = "Phylum", border_color = NA) + 
#   scale_fill_manual(values = cc10) + 
#   theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
#   theme_bw() + xlab("Day") + ylab("Relative abundance") +
#   theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
#   facet_grid(. ~ SubjectID, scales = "free", space = "free")
# phycomp

```

### NAMS - Family

```{r, fig.height =10, fig.width = 8}

fam <- tax_glom(nams, "Family")

## Normalize to relative abundance
famrel <- transform_sample_counts(fam, function(x) x/sum(x))

## Take top 10 most abundant genera
top10 <- names(sort(taxa_sums(famrel), TRUE))[1:10]
fam10 <- prune_taxa(top10, famrel)

famcomp <- plot_bar2(fam10, x = "Day", fill = "Family", border_color = NA) + 
  scale_fill_manual(values = cc10) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
  theme_bw() + xlab("Day") + ylab("Relative abundance") +
  theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
  facet_wrap(nutritional_group~SubjectID, scales = "free", nrow = 4)
famcomp
```

### NAMS - Genus

```{r, fig.height =10, fig.width = 8}

gen <- tax_glom(nams, "Genus")

## Normalize to relative abundance
genrel <- transform_sample_counts(gen, function(x) x/sum(x))

## Take top 10 most abundant genera
top10 <- names(sort(taxa_sums(genrel), TRUE))[1:10]
gen10 <- prune_taxa(top10, genrel)


gencomp <- plot_bar2(gen10, x = "Day", fill = "Genus", border_color = NA) + 
  scale_fill_manual(values = cc10) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
  theme_bw() + xlab("Day") + ylab("Relative abundance") +
  theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
  facet_wrap(nutritional_group~SubjectID, scales = "free", nrow = 4)
gencomp
```

### T1DMS - Phylum

```{r, fig.height = 10, fig.width = 8}
## Aggolomerate to Phylum level
phy <- tax_glom(tdm, "Phylum")

## Normalize to relative abundance
phyrel <- transform_sample_counts(phy, function(x) x/sum(x))

phycomp <- plot_bar2(phyrel, x = "Day", fill = "Phylum", border_color = NA) + 
  scale_fill_manual(values = cc10) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
  theme_bw() + xlab("Day") + ylab("Relative abundance") +
  theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
  facet_wrap(disease_type~SubjectID, scales = "free", nrow = 4)
phycomp
```

### T1DMS - Family

```{r, fig.height = 10, fig.width = 8}

fam <- tax_glom(tdm, "Family")

## Normalize to relative abundance
famrel <- transform_sample_counts(fam, function(x) x/sum(x))

## Take top 10 most abundant genera
top10 <- names(sort(taxa_sums(famrel), TRUE))[1:10]
fam10 <- prune_taxa(top10, famrel)

famcomp <- plot_bar2(fam10, x = "Day", fill = "Family", border_color = NA) + 
  scale_fill_manual(values = cc10) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
  theme_bw() + xlab("Day") + ylab("Relative abundance") +
  theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
  facet_wrap(disease_type~SubjectID, scales = "free", nrow = 4)
famcomp
```

### T1DMS - Genus

```{r, fig.height =10, fig.width = 8}

gen <- tax_glom(tdm, "Genus")

## Normalize to relative abundance
genrel <- transform_sample_counts(gen, function(x) x/sum(x))

## Take top 10 most abundant genera
top10 <- names(sort(taxa_sums(genrel), TRUE))[1:10]
gen10 <- prune_taxa(top10, genrel)


gencomp <- plot_bar2(gen10, x = "Day", fill = "Genus", border_color = NA) + 
  scale_fill_manual(values = cc10) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + 
  theme_bw() + xlab("Day") + ylab("Relative abundance") +
  theme(axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5), axis.text.y = element_blank()) +
  facet_wrap(disease_type~SubjectID, scales = "free", nrow = 4)
gencomp
```


## Alpha Diversity

Diversity within samples is measured here using the Shannon and Simpson index. In the plots below, each sample is represented by a point, horizontal bars denote the median and crosses denote the mean. 

### NAMS Overview

```{r, fig.height = 7, fig.width = 7}
## Make table of alpha diversity calculations
alpha <- estimate_richness(ps)
alpha_info <- sample_data(ps)
aa <- cbind(alpha, alpha_info)

aanams <- aa[aa$study_name == "NAMS",]

all <- aanams %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(all, aes(x = nutritional_group, y = AlphaDiversity, fill = Day)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = rainbow(4, v = 0.8)) +
  scale_x_discrete(name = "Nutritional Group", labels = c("Control", "Fasting", "Keto")) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 2, scales = "free")
a1
``` 

### NAMS - Baseline (Day 0)

```{r}
bl <- aanams[aanams$Day == "0",] 
cols1 <- c("#b31c13", "#f47421", "#ffd300")

toplot <- bl %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = nutritional_group, y = AlphaDiversity, fill = nutritional_group)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = cols1, name = "Nutritional Group", labels = c("Control", "Fasting", "Keto")) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~nutritional_group, data = bl)
kruskal.test(Simpson ~nutritional_group, data = bl)
```

#### Conclusion

At baseline, alpha diversity is not dependent on diet. 

### NAMS - Follow-up (Day 180)

```{r}
fu <- aanams[aanams$Day == "180",] 

toplot <- fu %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = nutritional_group, y = AlphaDiversity, fill = nutritional_group)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = cols1, name = "Nutritional Group", labels = c("Control", "Fasting", "Keto")) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~nutritional_group, data = fu)
kruskal.test(Simpson ~nutritional_group, data = fu)
```

#### Conclusion

At follow-up, alpha diversity is not dependent on diet. 

### NAMS - Day 0 vs Day 7

```{r}
fe <- aanams[aanams$nutritional_group == "fasting",]
fe2 <- fe[fe$Day %in% c("0", "7"),]

toplot <- fe2 %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = Day, y = AlphaDiversity, fill = Day)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = rainbow(4, v = 0.8)) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~Day, data = fe2)
kruskal.test(Simpson ~Day, data = fe2)
```

#### Conclusion

There is no significant effect of fasting on alpha diversity. 

### NAMS - Day 7 vs Day 180

```{r}
fe <- aanams[aanams$nutritional_group == "fasting",]
fe2 <- fe[fe$Day %in% c("7", "180"),]

toplot <- fe2 %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = Day, y = AlphaDiversity, fill = Day)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = rainbow(4, v = 0.8)[c(1,3)]) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~Day, data = fe2)
kruskal.test(Simpson ~Day, data = fe2)
```

#### Conclusion

There is no significant difference between alpha diversity at Day 7 and Day 180.

### NAMS - Diet effect

The change in alpha diversity is determined by subtracting the value observed at Day 0 from the value observed at Day 180.

```{r}
de <- aanams[aanams$Day %in% c("0", "180"),]

####################### Plot 1
toplot <- de %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))
a4 <- ggplot(toplot, aes(x = Day, y = AlphaDiversity, color = nutritional_group, group = SubjectID)) +
  geom_point() +
  facet_grid(Metric~nutritional_group, scales = "free") +
  scale_color_manual(values = cols1) +
  geom_line() +
  theme_bw()
a4

####################### Plot 2
patlist <- levels(as.factor(de$SubjectID))
patlist <- patlist[patlist != "NAMS0065"] # remove NAMS0065 because no Day 0 sample

Shannon_diff <- NULL
Simpson_diff <- NULL
Diet <- NULL
for (i in 1:length(patlist)){
	sub <- de[de$SubjectID == patlist[i],]
	Shannon <- sub[sub$Day == "180", 6] - sub[sub$Day == "0", 6]
	Simpson <- sub[sub$Day == "180", 7] - sub[sub$Day == "0", 7]
	treat <- sub[1, 21]
	Shannon_diff <- c(Shannon_diff, Shannon)
	Simpson_diff <- c(Simpson_diff, Simpson)
	Diet <- c(Diet, treat)
}		
		
delta <- data.frame(Shannon = Shannon_diff,
                    Simpson = Simpson_diff,
                    Diet = as.factor(Diet))

toplot <- delta %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a3 <- ggplot(toplot, aes(x = Diet, y = AlphaDiversity, fill = Diet)) + 
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  ylab("Change in alpha diversity") + xlab("Nutritional Group") +
  theme_bw() +
  theme(legend.position = "none") +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  geom_point(position = position_dodge(width = 0.75)) +
scale_fill_manual(values = cols1)+
  facet_wrap(~Metric, nrow = 1, scales = "free")
a3

fast <- delta[delta$Diet == "fasting",]
w1 <- wilcox.test(fast$Shannon, mu = 0, conf.int = TRUE)
w2 <- wilcox.test(fast$Simpson, mu = 0, conf.int = TRUE)
```

### NAMS - Fasting effect


```{r}
fast <- aanams[aanams$nutritional_group == "fasting",]

####################### Plot 1
toplot <- fast %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))
a4 <- ggplot(toplot, aes(x = Day, y = AlphaDiversity, color = SubjectID, group = SubjectID)) +
  geom_point() +
  facet_wrap(~Metric, scales = "free") +
  scale_color_manual(values = cc10) +
  geom_line() +
  theme_bw()
a4

####################### Plot 2
patlist <- levels(as.factor(fast$SubjectID))
patlist <- patlist[!(patlist %in% c("NAMS0065", "NAMS0059"))] # remove NAMS0065 because no Day 0 sample

Shannon <- NULL
Simpson <- NULL
Diff <- NULL
Patient <- NULL

for (i in 1:length(patlist)){
	sub <- fast[fast$SubjectID == patlist[i],]
	Shannon1 <- sub[sub$Day == "7", 6] - sub[sub$Day == "0", 6]
	Simpson1 <- sub[sub$Day == "7", 7] - sub[sub$Day == "0", 7]
	Shannon2 <- sub[sub$Day == "180", 6] - sub[sub$Day == "7", 6]
	Simpson2 <- sub[sub$Day == "180", 7] - sub[sub$Day == "7", 7]
	Shannon3 <- sub[sub$Day == "187", 6] - sub[sub$Day == "180", 6]
	Simpson3 <- sub[sub$Day == "187", 7] - sub[sub$Day == "180", 7]
	Shannon <- c(Shannon, Shannon1, Shannon2, Shannon3)
	Simpson <- c(Simpson, Simpson1, Simpson2, Simpson3)
	Diff <- c(Diff, "1", "2", "3")
	Patient <- c(Patient, patlist[i], patlist[i], patlist[i]) 
}
		
delta <- data.frame(Shannon = Shannon,
                    Simpson = Simpson,
                    Diff = as.factor(Diff),
                    Patient = as.factor(Patient))

toplot <- delta %>% gather(key = "Metric", value = "DeltaAlphaDiversity", c("Shannon", "Simpson"))

a3 <- ggplot(toplot, aes(x = Diff, y = DeltaAlphaDiversity, fill = Diff)) + 
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  ylab("Change in alpha diversity") + xlab("Diff") +
  theme_bw() +
  theme(legend.position = "none") +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  geom_point(position = position_dodge(width = 0.75)) +
scale_fill_manual(values = rainbow(4, v = 0.8)) +
  scale_x_discrete(name = "Time Range", labels = c("0-7", "7-180", "180-187"))+
  facet_wrap(~Metric, nrow = 1, scales = "free")
a3

```


### T1DMS Overview

```{r, fig.height = 7, fig.width = 7}
aatdm <- aa[aa$study_name == "T1DMS",]
cols2 <- c("#cccccb", "#5c89c7")

all <- aatdm %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(all, aes(x = disease_type, y = AlphaDiversity, fill = Day)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = rainbow(4, v = 0.8)) +
  scale_x_discrete(name = "Disease Type", labels = c("Control", "Type 1 Diabetes")) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 2, scales = "free")
a1
``` 

### T1DMS - Baseline (Day 0)

```{r}
bl <- aatdm[aatdm$Day == "0",] 

toplot <- bl %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = disease_type, y = AlphaDiversity, fill = disease_type)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = cols2, name = "Disease Type", labels = c("Control", "Type 1 Diabetes")) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~disease_type, data = bl)
kruskal.test(Simpson ~disease_type, data = bl)
```

#### Conclusion

At baseline, alpha diversity is not dependent on disease type. 

### T1DMS - Follow-up (Day 150)

```{r}
fu <- aatdm[aatdm$Day == "150",] 

toplot <- fu %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = disease_type, y = AlphaDiversity, fill = disease_type)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = cols2, name = "Disease Type", labels = c("Control", "Type 1 Diabetes")) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~disease_type, data = fu)
kruskal.test(Simpson ~disease_type, data = fu)
```

#### Conclusion

At follow-up, alpha diversity is not dependent on disease type. 

### T1DMS - Fasting effect in control patients

```{r}
fe <- aatdm[aatdm$Day %in% c("0", "7"),]
fe2 <- fe[fe$disease_type == "control",]

toplot <- fe2 %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = Day, y = AlphaDiversity, fill = Day)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = rainbow(4, v = 0.8)) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~Day, data = fe2)
kruskal.test(Simpson ~Day, data = fe2)
```

#### Conclusion

In control patients, there is no significant effect of fasting on alpha diversity.


### T1DMS - Fasting effect in Type 1 diabetes patients

```{r}
fe <- aatdm[aatdm$Day %in% c("0", "7"),]
fe2 <- fe[fe$disease_type == "T1DM",]

toplot <- fe2 %>% gather(key = "Metric", value = "AlphaDiversity", c("Shannon", "Simpson"))

a1 <- ggplot(toplot, aes(x = Day, y = AlphaDiversity, fill = Day)) +
  geom_boxplot(outlier.fill = NULL, outlier.shape = 21) +
  scale_fill_manual(values = rainbow(4, v = 0.8)) +
  stat_summary(fun = base::mean, geom = "point", shape = 4, size = 4, position = position_dodge(width = 0.75)) +
  theme_bw() +
  geom_point(position = position_dodge(width = 0.75)) +
  facet_wrap(~Metric, nrow = 1, scales = "free")
a1
```

#### Statistics

```{r}
kruskal.test(Shannon ~Day, data = fe2)
kruskal.test(Simpson ~Day, data = fe2)
```

#### Conclusion

In patients with Type 1 Diabetes, there is a significant increase in alpha diversity associated with fasting. 

## Beta Diversity

Beta diversity is calculated here using Principal Coordinates Analysis (PCoA) on Bray-Curtis distances. In this plot the microbiome of each sample is represented by a dot. Dots that are close together in the graph are interpreted as being similar in bacterial composition, whereas dots that are far apart are interpreted as being different in bacterial composition.

### NAMS - All samples

```{r, fig.height = 3, fig.width = 8}
## Subset data
nams <- prune_samples(sample_data(pslog)$study_name == "NAMS", psf)
tdm <- prune_samples(sample_data(pslog)$study_name == "T1DMS", psf)

ord <- ordinate(nams, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(nams, ord, color = "Day") +
  facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = rainbow(4, v= 0.8)) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb
```

### NAMS - Baseline (Day 0)

```{r, fig.height = 4, fig.width = 7}
## Subset data
d0 <- prune_samples(sample_data(nams)$Day == "0", nams)
d180 <- prune_samples(sample_data(nams)$Day == "180", nams)

ord <- ordinate(d0, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(d0, ord, color = "nutritional_group") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = cols1) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb
```

#### Permanova


```{r}
focal <- d0
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$nutritional_group)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant difference between the composition of samples at baseline.

### NAMS - Follow-up (Day 180)

```{r, fig.height = 4, fig.width = 7}
ord <- ordinate(d180, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(d180, ord, color = "nutritional_group") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = cols1) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb

```

#### Permanova

```{r}
focal <- d180
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$nutritional_group)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant difference between the composition of samples at follow-up.

### NAMS - Fasting effect

```{r, fig.height = 4, fig.width = 7}
## Subset data
fast <- prune_samples(sample_data(nams)$nutritional_group == "fasting", nams)
fast2 <- prune_samples(sample_data(fast)$Day %in% c("0", "7"), fast)

ord <- ordinate(fast2, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(fast2, ord, color = "Day") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = rainbow(4, v= 0.8)) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb

```

#### Permanova

```{r}
focal <- fast2
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$Day)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant effect of fasting on the community composition.

### NAMS - Length of effect

```{r, fig.height = 4, fig.width = 7}
## Subset data
fast2 <- prune_samples(sample_data(fast)$Day %in% c("0", "180"), fast)

ord <- ordinate(fast2, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(fast2, ord, color = "Day") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = rainbow(4, v= 0.8)) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb

```

#### Permanova

```{r}
focal <- fast2
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$Day)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant difference between the composition of communities at Day 0 compared to Day 180 in the fasting treatment group.


### T1DMS - All samples

```{r, fig.height = 3, fig.width = 7}

ord <- ordinate(tdm, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(tdm, ord, color = "Day") +
  facet_wrap(~disease_type, nrow = 1)+
  scale_colour_manual(values = rainbow(3, v= 0.8)) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb
```

### T1DMS - Baseline (Day 0)

```{r, fig.height = 4, fig.width = 7}
## Subset data
d0 <- prune_samples(sample_data(tdm)$Day == "0", tdm)
d7 <- prune_samples(sample_data(tdm)$Day == "7", tdm)
d150 <- prune_samples(sample_data(tdm)$Day == "150", tdm)


ord <- ordinate(d0, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(d0, ord, color = "disease_type") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = cols2) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb

```

#### Permanova

```{r}
focal <- d0
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$disease_type)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant difference between the composition of samples at baseline.

### T1DMS - Post-fasting (Day 7)

```{r, fig.height = 4, fig.width = 7}
ord <- ordinate(d7, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(d7, ord, color = "disease_type") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = cols2) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb
```

#### Permanova

```{r}

focal <- d7
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$disease_type)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant difference between the composition of samples post-fasting.


### Follow-up (Day 150)

```{r, fig.height = 4, fig.width = 7}
ord <- ordinate(d150, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(d150, ord, color = "disease_type") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = cols2) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb
```

#### Permanova

```{r}

focal <- d150
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$disease_type)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant difference between the composition of samples at follow-up.

### T1DMS - Fasting effect in control patients

```{r}
## Subset data
fec <- prune_samples(sample_data(tdm)$Day %in% c("0", "7"), tdm)
fec2 <- prune_samples(sample_data(fec)$disease_type == "control", fec)


ord <- ordinate(fec2, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(fec2, ord, color = "Day") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = rainbow(4, v = 0.8)) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb

```

#### Permanova

```{r}
focal <- fec2
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$Day)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant effect of fasting on the community composition in control patients. 

### T1DMS - Fasting effect in Type 1 diabetes patients

```{r}
## Subset data
fec <- prune_samples(sample_data(tdm)$Day %in% c("0", "7"), tdm)
fec2 <- prune_samples(sample_data(fec)$disease_type == "T1DM", fec)


ord <- ordinate(fec2, method = "PCoA", distance = "bray")
evals <- ord$values$Eigenvalues
bb <- plot_ordination(fec2, ord, color = "Day") +
  #facet_wrap(~nutritional_group, nrow = 1)+
  scale_colour_manual(values = rainbow(4, v = 0.8)) +
  coord_fixed(sqrt(evals[2]/evals[1])) +
  theme_bw()
bb

```

#### Permanova

```{r}
focal <- fec2
permanova <- adonis(dist(otu_table(focal)) ~ sample_data(focal)$Day)

#kable(permanova$aov.tab) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
permanova$aov.tab
```

#### Conclusion

There is no significant effect of fasting on the community composition in patients with type 1 diabetes.

<!-- ## Differential Adundance -->

<!-- Differentially abundant taxa are determined using DESeq2 on VST-transformed counts. For purposes of visualization, heatmaps show count data (log2 transformed) of all taxa that differ significantly between groups (padj < 0.01). -->

<!-- ### NAMS - fasting effect -->

<!-- ```{r} -->

<!-- alpha <- 0.01 -->
<!-- ####################################### -->
<!-- ## Subset data -->
<!-- nams <- prune_samples(sample_data(ps)$study_name == "NAMS", ps) -->
<!-- tdm <- prune_samples(sample_data(ps)$study_name == "T1DMS", ps) -->

<!-- ## NAMS - fasting effect -->
<!-- nfe <- prune_samples(sample_data(nams)$nutritional_group == "fasting", nams) -->
<!-- nfe2 <- prune_samples(sample_data(nfe)$Day %in% c("0", "7"), nfe) -->

<!-- ## T1DMS - fasting effect in control patients -->
<!-- tfe <- prune_samples(sample_data(tdm)$Day %in% c("0", "7"), tdm) -->
<!-- tfec <- prune_samples(sample_data(tfe)$disease_type == "control", tfe) -->

<!-- ## T1DMS - fasting effect in patients with type 1 diabetes -->
<!-- tfed <- prune_samples(sample_data(tfe)$disease_type == "T1DM", tfe) -->

<!-- ####################################### -->

<!-- ## NAMS diet effect -->
<!-- psin <- nfe2 -->

<!-- diagdds <- phyloseq_to_deseq2(psin, ~Day) -->
<!-- gm_mean = function(x, na.rm=TRUE){ -->
<!--   exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x)) -->
<!-- } -->
<!-- geoMeans = apply(counts(diagdds), 1, gm_mean) -->
<!-- diagdds = estimateSizeFactors(diagdds, geoMeans = geoMeans) -->
<!-- diagdds = DESeq(diagdds, fitType="local") -->

<!-- ## Compare  -->
<!-- rr <- results(diagdds) -->
<!-- ss <- rr[which(rr$padj < alpha),] -->

<!-- sigtaxa <- rownames(ss) -->

<!-- # Subset taxa -->
<!-- sigps <- prune_taxa(sigtaxa,psin) -->
<!-- # Log2 transform for visualization -->
<!-- sigpslog <- transform_sample_counts(sigps, function(x) log2(x + 0.5)) -->

<!-- mat <- as(otu_table(sigpslog), "matrix") -->
<!-- tmat <- t(mat) -->
<!-- tax_org <- data.frame(row.names = taxa_names(sigps), Phylum = tax_table(sigps)[,2]) -->
<!-- sample_org <- data.frame(row.names = sample_names(sigps), sample_data(sigps)[,26]) -->
<!-- matordered <- tmat[order(factor(tax_org$Phylum)),order(sample_org$Day)] -->
<!-- gnames <- tax_table(sigps)[order(factor(tax_org$Phylum)),] -->
<!-- gnames <- gnames[,6] -->

<!-- ## Set colours -->
<!-- my_colour = list( -->
<!--   Day = c("0" = "#CC0000", "7" = "#66CC00"), -->
<!--   Phylum = c(Bacteroidota = cc10[2], -->
<!--              Firmicutes = cc10[6], -->
<!--              Verrucomicrobiota = cc10[9])) -->

<!-- hm <- pheatmap(matordered, -->
<!--          cluster_rows = FALSE, -->
<!--          cluster_cols = FALSE, -->
<!--          color = colorRampPalette(c("white", "#66CCFF", "#000033"))(100), -->
<!--          annotation_row = tax_org, -->
<!--          annotation_col = sample_org, -->
<!--          gaps_col = c(9), -->
<!--          gaps_row = c(1), -->
<!--          #annotation_colors = my_colour, -->
<!--          labels_row = gnames, -->
<!--          show_colnames= FALSE, -->
<!--          cellheight = 10, -->
<!--          #cellwidth = 8,  -->
<!--          fontsize = 8) -->
<!-- hm -->
<!-- ``` -->

<!-- ### T1DMS - fasting effect in control patients -->

<!-- ```{r} -->
<!-- psin <- tfec -->

<!-- diagdds <- phyloseq_to_deseq2(psin, ~Day) -->
<!-- gm_mean = function(x, na.rm=TRUE){ -->
<!--   exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x)) -->
<!-- } -->
<!-- geoMeans = apply(counts(diagdds), 1, gm_mean) -->
<!-- diagdds = estimateSizeFactors(diagdds, geoMeans = geoMeans) -->
<!-- diagdds = DESeq(diagdds, fitType="local") -->

<!-- ## Compare  -->
<!-- rr <- results(diagdds) -->
<!-- ss <- rr[which(rr$padj < alpha),] -->

<!-- sigtaxa <- rownames(ss) -->

<!-- # Subset taxa -->
<!-- sigps <- prune_taxa(sigtaxa,psin) -->
<!-- # Log2 transform for visualization -->
<!-- sigpslog <- transform_sample_counts(sigps, function(x) log2(x + 0.5)) -->

<!-- mat <- as(otu_table(sigpslog), "matrix") -->
<!-- tmat <- t(mat) -->
<!-- tax_org <- data.frame(row.names = taxa_names(sigps), Phylum = tax_table(sigps)[,2]) -->
<!-- sample_org <- data.frame(row.names = sample_names(sigps), sample_data(sigps)[,26]) -->
<!-- matordered <- tmat[order(factor(tax_org$Phylum)),order(sample_org$Day)] -->
<!-- gnames <- tax_table(sigps)[order(factor(tax_org$Phylum)),] -->
<!-- gnames <- gnames[,6] -->

<!-- ## Set colours -->
<!-- my_colour = list( -->
<!--   Day = c("0" = "#CC0000", "7" = "#66CC00"), -->
<!--   Phylum = c(Bacteroidota = cc10[2], -->
<!--              Firmicutes = cc10[6], -->
<!--              Proteobacteria = cc10[7])) -->

<!-- hm <- pheatmap(matordered, -->
<!--          cluster_rows = FALSE, -->
<!--          cluster_cols = FALSE, -->
<!--          color = colorRampPalette(c("white", "#66CCFF", "#000033"))(100), -->
<!--          annotation_row = tax_org, -->
<!--          annotation_col = sample_org, -->
<!--          gaps_col = c(7), -->
<!--          gaps_row = c(3,10), -->
<!--          annotation_colors = my_colour, -->
<!--          labels_row = gnames, -->
<!--          show_colnames= FALSE,  -->
<!--          fontsize = 8, -->
<!--          cellheight = 10) -->
<!--          #cellwidth = 8) -->
<!-- hm -->

<!-- ``` -->

<!-- ### T1DMS - fasting effect in patients with type 1 diabetes -->

<!-- ```{r} -->
<!-- psin <- tfed -->

<!-- diagdds <- phyloseq_to_deseq2(psin, ~Day) -->
<!-- gm_mean = function(x, na.rm=TRUE){ -->
<!--   exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x)) -->
<!-- } -->
<!-- geoMeans = apply(counts(diagdds), 1, gm_mean) -->
<!-- diagdds = estimateSizeFactors(diagdds, geoMeans = geoMeans) -->
<!-- diagdds = DESeq(diagdds, fitType="local") -->

<!-- ## Compare  -->
<!-- rr <- results(diagdds) -->
<!-- ss <- rr[which(rr$padj < alpha),] -->

<!-- sigtaxa <- rownames(ss) -->

<!-- # Subset taxa -->
<!-- sigps <- prune_taxa(sigtaxa,psin) -->
<!-- # Log2 transform for visualization -->
<!-- sigpslog <- transform_sample_counts(sigps, function(x) log2(x + 0.5)) -->

<!-- mat <- as(otu_table(sigpslog), "matrix") -->
<!-- tmat <- t(mat) -->
<!-- tax_org <- data.frame(row.names = taxa_names(sigps), Phylum = tax_table(sigps)[,2]) -->
<!-- sample_org <- data.frame(row.names = sample_names(sigps), sample_data(sigps)[,26]) -->
<!-- matordered <- tmat[order(factor(tax_org$Phylum)),order(sample_org$Day)] -->
<!-- gnames <- tax_table(sigps)[order(factor(tax_org$Phylum)),] -->
<!-- gnames <- gnames[,6] -->

<!-- ## Set colours -->
<!-- my_colour = list( -->
<!--   Day = c("0" = "#CC0000", "7" = "#66CC00"), -->
<!--   Phylum = c(Actinobacteriota = cc10[1], -->
<!--              Bacteroidota = cc10[2], -->
<!--              Firmicutes = cc10[6])) -->

<!-- hm <- pheatmap(matordered, -->
<!--          cluster_rows = FALSE, -->
<!--          cluster_cols = FALSE, -->
<!--          color = colorRampPalette(c("white", "#66CCFF", "#000033"))(100), -->
<!--          annotation_row = tax_org, -->
<!--          annotation_col = sample_org, -->
<!--          gaps_col = c(18), -->
<!--          gaps_row = c(1,2,9), -->
<!--          #annotation_colors = my_colour, -->
<!--          labels_row = gnames, -->
<!--          show_colnames= FALSE,  -->
<!--          fontsize = 8,  -->
<!--          cellheight = 10)  -->
<!--          #width = 8) -->
<!--          #cellheight = 10, -->
<!--          #cellwidth = 8) -->
<!-- hm -->
<!-- ``` -->



